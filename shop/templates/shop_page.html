
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order form</title>
    <script src="https://kit.fontawesome.com/yourcode.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<style>
    .products{
    }
    input{
        width: 250px;
        box-sizing: border-box;
        padding: 8px;
        margin-top: 5px;
    }
    .search{
        background-color: #0f790f;
        color: #fff;
        padding: 10px;
        border: none;
        font-size: 18px;
        width: 100px;
        border-radius: 5px;
        margin-top: -11px;

        /*margin-left: 100px;*/
    }
    .search:hover{
        background-color: #139313;

    }
    .search:active{
        background-color: #19be19;
    }
    .search:focus{
    }
.form {
        position: relative;
        text-align: center;
    }

.results{
text-align: center;
}
.NoRes{
    text-align: center;
    font-size: 20px;
    margin-top: 200px;

}
.document-container {
    margin: 0 auto;
    display: flex;
    border: 2px solid #ddd;
    margin-bottom: 10px;
    width: 1000px;
    height: 200px;
    {#padding: 10px;#}
}

.document-image {
    width: 199px;
    height: 196px;
    margin-right: 10px;
    border-right:  2px solid #ddd;
}
.number-in-cart{
    width: 32px;
    height: 196px;
    margin-right: 10px;
    border-right:  2px solid #ddd;
    text-align: center;
    display: flex;        /* Use flexbox */
    justify-content: center; /* Center horizontally */
    align-items: center;  /* Center vertically */
    font-size: 30px;
    position: relative;
    {#align-items: center;#}
    {#justify-content: center;#}
    {#bottom:50%;#}
}

.document-info {

    position: relative;
    flex-grow: 1;
    padding-top: 10px;
}

.document-number {
    padding-top: 10px;
    position: absolute;
    top: 0;
    font-size: 20px;
    width: 100%;
    text-align: center;
    font-weight: bold;
}

.document-price {
    position: absolute;
    bottom: 0;
    left: 0;
    font-weight: bold;
    font-size: 25px;
    padding: 5px;
}
 #dropdown {
        max-height: 200px;
        overflow-y: auto;
        width: 250px; /* Match the width of your input field */
        background-color: white;
        border: 1px solid #ddd;
        position: absolute;
        left: 50%; /* Set left to 50% of the parent element */
        transform: translateX(-50%); /* Move back by 50% of its own width */
        top: 80px; /* Adjust based on the height of your input field and label */
        z-index: 1000;
    }

    #dropdown div {
        cursor: pointer;
        padding: 5px;
    }

    #dropdown div:hover {
        background-color: #f0f0f0;
    }
    .price-and-cart {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .purchase,.quantity-control, .quantity-input {
        position: absolute;
        bottom: 0;
        padding: 10px;
        left: 50%; /* Set left to 50% of the parent element */
        transform: translateX(-50%); /* Move back by 50% of its own width */
        margin-bottom: 5px;
    }
    .quantity-slider, .quantity-slider .quantitySlider {
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    bottom: 0;
    {#padding: 10px;#}
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 5px;
        height: 60px;
}
    .quantity-slider .quantitySlider {
        margin-bottom: 15px;
    }

.quantity-slider .min, .quantity-slider .max {
    margin: 0 10px; /* Add some space around min and max */
    font-size: 18px;
}
.quantity-slider .slider{
    transform: translateY(+10px);
}
    .purchase{
   background-color: #01447B;
         width: 120px;
        height: 50px;
         border-radius: 5px;
        color: #efefef;
    }
    .quantity-control{
    border: 1px solid ;
    border-color: #cbcbcb;
    border-radius: 5px;

    }
     .radio-buttons input[type="radio"] {
    display: none;
}
    .radio-buttons {

    display: flex;
    justify-content: center;
    align-items: center;
}


.radio-buttons label {
    display: inline-block;
    background-color: #f0f0f0;
    padding: 10px 20px;
    margin-left: 5px;
    margin-right: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    {#left: 150%;#}
    {#margin-bottom: 15px;#}

}

/* Change the appearance when the radio button is checked */
.radio-buttons input[type="radio"]:checked + label {
    background-color: #033e7e;
    color: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    border-color: #0056b3;
}
.inp{
    width: 200px;
}



    .quantity-increase, .quantity-decrease {
    background-color: #f8f8f8; /* Light gray background */
    color: rgba(51, 51, 51, 0.84); /* Darker text for contrast */

    border: 1px solid; /* No border for a modern look */
        border-color: #cbcbcb ;
    padding: 5px 10px; /* Padding for better touch area */
    font-size: 18px; /* Larger font for readability */
    font-weight: bold; /* Bold font for emphasis */
    cursor: pointer; /* Cursor changes to pointer to indicate clickability */
    border-radius: 3px; /* Slightly rounded corners */
        width: 50px;

        height: 40px;
    transition: background-color 0.3s; /* Smooth transition for hover effect */
}
    .quantity-increase{
        margin-left:20px ;
    }
    .quantity-decrease{
        margin-right:20px ;
    }

.quantity-increase:hover, .quantity-decrease:hover {
    background-color: #e6e6e6; /* Slightly darker background on hover */
}

.quantity-increase:active, .quantity-decrease:active {
    background-color: #cccccc; /* Even darker background when clicked */
}
.deleteBut{
    font-size: 28px;
    position: absolute;
    top:0;
    right:0;
    color: #CC4500;
    margin-right:10px;
    cursor: pointer;
}
.quantity-input-button{
    background-color: #1daede;
        color: #fff;
        padding: 10px;
        border: none;
        font-size: 18px;
        cursor: pointer;
        width: 100px;
        border-radius: 5px;
        margin-top: -11px;
}
.sum{
    position: absolute;
    bottom: 0;
    right: 0;
    font-weight: bold;
    font-size: 25px;
    padding: 5px;
}
</style>
<body>
{% include 'base.html' %}
<div class="form">
<form action="" method="Post" id="searchForm">
    {% csrf_token %}
    <label for="number" style="font-size: 22px">Product number</label>
    <br>
    <input name="number" id="number" onkeyup="updateDropdown()" autocomplete="off">
    <br>
    <div id="dropdown"></div>
    <br>
    <button type="submit" class="search">Search</button>
</form>
</div>
<div class="products">
{% if documents %}
    <div class="results">
    {% if search_term %}
    <h2>Searched Results for "{{ search_term }}":</h2>
{% else %}
    <h2>Searched Results:</h2>
{% endif %}
    </div>
    <ul>
      {% for document in documents %}

    <div class="document-container" data-document="{{ document }}">
        <div class="number-in-cart" data-product-id="{{ document.name }}" style="{% if not inside %} display: none {% endif %}">{{ document.number }}</div>
        <img class="document-image" src="{{ document.image_url }}" alt="{{ document.name }}">
        <div class="document-info" id="info-{{ document.name }}">

            <div class="document-number">{{ document.name }}</div> <br>
            <div class="document-description">{{ document.description }}</div>
            <br>
            <div class="document-price" >€{{ document.price }}</div>
            <div class="deleteBut"  data-product-id="{{ document.name }}" style="{% if not inside %} display: none {% endif %}" ><i class="fa-solid fa-trash"></i></div>


            <div class="radio-buttons" data-product-id="{{ document.name }}" id="radio-buttons-{{ document.name }}" style="{% if not inside %} display: none {% endif %}">
                <input type="radio" id="quantityControlRadio-{{ document.name }}" name="displayOption-{{ document.name }}" value="quantityControl" checked>
                <label for="quantityControlRadio-{{ document.name }}">Quantity Control</label>

                <input type="radio" id="quantitySliderRadio-{{ document.name }}" name="displayOption-{{ document.name }}" value="quantitySlider">
                <label for="quantitySliderRadio-{{ document.name }}">Quantity Slider</label>

                <input type="radio" id="quantityInputRadio-{{ document.name }}" name="displayOption-{{ document.name }}" value="quantityInput">
                <label for="quantityInputRadio-{{ document.name }}">Quantity Input</label>
            </div>


            <div class="quantity-input" id="quantity-input-{{ document.name }}" style="display: none">
                   <input class="inp" min=1 id="quantity-input-inp-{{ document.name }}" type="number" placeholder="Enter the quantity">
                <button class="quantity-input-button" id="quantity-input-apply-{{ document.name }}">Apply</button>
            </div>


            <div class="quantity-slider" id="quantity-slider-{{ document.name }}" style="display: none">
                <span class="quantitySlider" id="quantity-slider-text-{{ document.name }}">{{ quantity }}</span> <br>
                <span class="min">{{ 1 }}</span>
                <input type="range" min="1" max="{{ document.quantity }}" value="{{ quantity }}" class="slider" id="slider-{{ document.name }}">
                <span class="max">{{ document.quantity }}</span>
            </div>


            <div class="quantity-control" id="quantity-control-{{ document.name }}" style="{% if not inside %} display: none {% endif %}">
                    <button class="quantity-decrease" data-product-id="{{ document.name }}">-</button>
                    <span class="quantity" id="quantity-{{ document.name }}">{{ quantity }}</span>
                    <button class="quantity-increase" data-product-id="{{ document.name }}">+</button>
            </div>

            <button class="purchase" data-product-id="{{ document.name }}" style="{% if inside %} display: none {% endif %}">Add to cart</button>
            <br>
            <span class="sum" id="sum-{{ document.name }}" style="{% if not inside %} display: none {% endif %}">{{ document.price }}</span>
        </div>
    </div>
{% endfor %}
</ul>
    </div>
{% else %}
    <div class="NoRes">
    <p>No results to display.</p>
    </div>
{% endif %}

</body>
</html>
    <script>
    document.getElementById('searchForm').addEventListener('submit', function() {
        {#localStorage.clear();#}
    });
    function updateDropdown() {
        var inputVal = document.getElementById('number').value;
        if (inputVal.length === 0) {
            document.getElementById('dropdown').innerHTML = '';
            return;
        }
        fetch('/fetch-numbers/?term=' + inputVal)
            .then(response => response.json())
            .then(data => {
                let dropdownHTML = '';
                data.forEach((item) => {
                    dropdownHTML += `<div onclick="fillInput('${item}')">${item}</div>`;
                });
                document.getElementById('dropdown').innerHTML = dropdownHTML;
            });
    }

    function fillInput(value) {
        document.getElementById('number').value = value;
        document.getElementById('dropdown').innerHTML = '';
    }

    document.querySelectorAll('.purchase').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const documentContainer = this.closest('.document-container');
            const documentValue = documentContainer.getAttribute('data-document');
            fetch('{% url "add_to_cart" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ document: documentValue })
            }).then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      document.getElementById('quantity-' + productId).innerText = data.quantity;
                      console.log(document.getElementById('quantity-' + productId).innerText);
                      togglePurchaseButton(productId);
                      saveState('quantity-'+productId, 1);
                      saveState("number-"+productId, data.number);
                      saveState("sum-"+productId, "€"+data.sum);
                      restoreState();


                  }
              });
        });
    });

    function togglePurchaseButton(productId) {
    const purchaseButton = document.querySelector('.purchase[data-product-id="' + productId + '"]');
    const deleteButton = document.querySelector('.deleteBut[data-product-id="' + productId + '"]');
    const number = document.querySelector('.number-in-cart');
    const quantityControl = document.getElementById('quantity-control-' + productId);
    const radioButtons = document.getElementById('radio-buttons-'+productId); // Assuming each set of radio buttons has an ID like this
    const sum = document.getElementById('sum-'+productId);

    purchaseButton.style.display = 'none';
    number.style.display = 'flex';
    quantityControl.style.display = 'block';
    deleteButton.style.display = 'inline';
    radioButtons.style.display = 'flex';
    sum.style.display = 'block';

    const quantityControlRadio = document.getElementById('quantityControlRadio-' + productId);
    quantityControlRadio.checked = true;
}

    document.querySelectorAll('.quantity-increase').forEach(button => {
    button.addEventListener('click', function() {
        const documentContainer = this.closest('.document-container');
            const documentValue = documentContainer.getAttribute('data-document');

            const productId = this.getAttribute('data-product-id');
            console.log(productId);
        updateQuantity(productId, 1, documentValue);  // Increase quantity by 1
    });
});

document.querySelectorAll('.quantity-decrease').forEach(button => {
    button.addEventListener('click', function() {
        const documentContainer = this.closest('.document-container');
            const documentValue = documentContainer.getAttribute('data-document');
        const productId = this.getAttribute('data-product-id');

        updateQuantity(productId, -1, documentValue);  // Decrease quantity by 1
    });
});

function updateQuantity(productId, change, documentValue) {

    fetch('{% url "update_quantity" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ product_id: productId, quantity_change: change, 'document': documentValue})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const quantityElement = document.getElementById('quantity-' + productId);
            quantityElement.innerText = data.quantity;
            const sum  = document.getElementById('sum-'+productId);
             sum.innerHTML = "Total" + "<br>" + data.sum;
            saveState('sum-'+productId, data.sum);
            saveState('quantity-'+productId, data.quantity);
        } else {
            if(data.message === 'You have reached maximum quantity') {
                alert(data.message);
            }
            else{
                console.error('Failed to update quantity:', data.message);
            }
        }
    });
}
document.querySelectorAll('.deleteBut').forEach(button => {
    button.addEventListener('click', function() {
        const documentId = this.getAttribute('data-product-id');

        const confirmed = confirm("Do you really want to delete this product from your cart?");

        if (confirmed) {
            fetch('{% url "delete_document" %}', {  // Replace with your actual URL
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ document_id: documentId })
            })
            .then(response => {
                if(response.ok) {
                    console.log('Document deleted successfully');
                    toggleQuantityForm(documentId);
                    {#let savedValue = localStorage.getItem('displayOption-'+documentId);#}
                    {#localStorage.clear();#}
                } else {
                    console.error('Error in deletion');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
});
 function toggleQuantityForm(productId) {
    const quantityControl = document.getElementById('quantity-control-' + productId);
    const purchaseButton = document.querySelector('.purchase[data-product-id="' + productId + '"]');
    const delBut = document.querySelector('.deleteBut[data-product-id="' + productId + '"]');
    const radioButtons = document.getElementById('radio-buttons-'+productId); // Assuming each set of radio buttons has an ID like this
     const slider = document.getElementById('quantity-slider-'+productId);
     const input = document.getElementById('quantity-input-'+productId);
     const number = document.querySelector('.number-in-cart');
     const sum = document.getElementById('sum-'+productId);


    if (quantityControl && purchaseButton && delBut && radioButtons) {
        quantityControl.style.display = 'none'; // Hide the quantity control
        purchaseButton.style.display = 'block'; // Show the purchase button
        delBut.style.display = 'none';
        radioButtons.style.display = 'none';
        slider.style.display = 'none';
        number.style.display = 'none';
        input.style.display = 'none';
        sum.style.display = 'none';
    }
}
document.addEventListener('DOMContentLoaded', function() {
    restoreState();
});
document.querySelectorAll('.radio-buttons input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const documentContainer = this.closest('.document-container');
        const documentString = documentContainer.getAttribute('data-document');
        const doc = documentString.replace(/'/g, '"');

        const dataObject = JSON.parse(doc);

        const docName = dataObject.name;

        const quantityControl = document.getElementById('quantity-control-' + docName);
        const quantitySlider = document.getElementById('quantity-slider-' + docName);
        const quantityInput = document.getElementById('quantity-input-' + docName);
        if (this.value === 'quantityControl') {
            const quantityElementCOntrol = document.getElementById('quantity-' + docName);
            quantityElementCOntrol.innerText = localStorage.getItem('quantity-'+docName);
            quantityControl.style.display = 'block';
            quantitySlider.style.display = 'none';
            quantityInput.style.display = 'none';
        } else if (this.value === 'quantitySlider') {
            const quantityElement = document.getElementById('quantity-slider-text-' + docName);
            const slider = document.getElementById('slider-'+docName);
            quantityElement.innerText = localStorage.getItem('quantity-'+docName);
            slider.value = localStorage.getItem('quantity-'+docName);
            quantitySlider.style.display = 'flex';
            quantityControl.style.display = 'none';
            quantityInput.style.display = 'none';
        }else if (this.value === 'quantityInput') {
            quantitySlider.style.display = 'none';
            quantityControl.style.display = 'none';
            quantityInput.style.display = 'block';
            const inp = document.getElementById('quantity-input-inp-' + docName);
            inp.value = '';
        }
        {#saveState(this.name, this.value);#}
    });
});
 function saveState(name, value) {
    localStorage.setItem(name, value);
}
 function restoreState() {
    document.querySelectorAll('.radio-buttons').forEach(group => {
    let radios = group.querySelectorAll('input[type="radio"]');

    if (radios.length > 0) {
        radios[0].checked = true;
        {#radios[0].dispatchEvent(new Event('change'));#}
    }
});
    const Id =  document.querySelector('.number-in-cart').getAttribute('data-product-id');
    document.querySelector('.number-in-cart').innerText = localStorage.getItem('number-'+Id);

    const sum = document.getElementById('sum-'+Id);
    console.log(localStorage.getItem('sum-'+Id));
    sum.innerHTML = sum.innerHTML = "Total" + "<br>" +localStorage.getItem('sum-'+Id);
}
 $(document).ready(function(){
    $('.slider').on('input change', function() {
        let product_id = $(this).attr('id').split('-')[1]; // Assuming ID is 'slider-{{ document.name }}'
        let quantity_new = $(this).val();
        const price= document.getElementById('info-'+product_id).querySelector('.document-price').textContent.replace("€","");
        let doc = { 'name': product_id, 'quantity': $(this).attr('max'), 'price': price };
        updateQuantitySlider(product_id, quantity_new, doc);
    });
});

function updateQuantitySlider(product_id, quantity_new, doc) {
    $.ajax({
        url: '{% url "update_slider" %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            product_id: product_id,
            quantity_new: quantity_new,
            document: doc
        }),
        success: function(response) {
            const quantityElement = document.getElementById('quantity-slider-text-' + response.product_id);
            quantityElement.innerText = response.quantity;
            const sum  = document.getElementById('sum-'+response.product_id);
            sum.innerHTML = "Total" + "<br>" + response.sum;
            saveState('sum-'+product_id, response.sum);
            saveState('quantity-'+response.product_id, response.quantity);
        },
        error: function(error) {
            console.log(error);
        }
    });
}
document.querySelectorAll('.quantity-input-button').forEach(button => {
    button.addEventListener('click', function() {
        // Find the closest '.document-container' ancestor of the clicked button
        const documentContainer = this.closest('.document-container');
        // Parse the 'data-document' attribute value as JSON
        const documentValue = JSON.parse(documentContainer.getAttribute('data-document').replace(/'/g, '"'));
        // Extract the product ID from the document value
        const productId = documentValue['name'];


        // Find the corresponding input element for the product ID
        const inp = document.getElementById('quantity-input-inp-' + productId);
        // Parse the input value as an integer
        const quantity = parseInt(inp.value);

        // Validate the input quantity
        if (isNaN(quantity) || quantity <= 0) {
            alert("Type of written quantity has to be numeric and greater than 0");
        }
        else if (quantity > documentValue.quantity) {

            alert("Quantity has to be less than maximum on storage");
        }
        else {
            // Call a function to handle the quantity input update
            updateQuantityInput(productId, quantity, documentValue);
        }
    });
});

    function updateQuantityInput(product_id, quantity_new, doc) {
    fetch('{% url "update_input" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ product_id: product_id, quantity_new: quantity_new, 'document': doc, price:doc.price})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const button = document.getElementById("quantity-input-apply-"+ product_id);
            button.innerText = "Applied!";
            button.style.background = "#06b206";
            const quantityElement = document.getElementById('quantity-slider-text-' + data.product_id);
            quantityElement.innerText = quantity_new;
            const sum  = document.getElementById('sum-'+data.product_id);
            sum.innerHTML = "Total" + "<br>" + data.sum;
            saveState('sum-'+product_id, data.sum);
            saveState('quantity-'+data.product_id, data.quantity);
        } else {
        }
    });

    }
    document.querySelectorAll('.quantity-input input[type="number"]').forEach(input => {
    input.addEventListener('input', function() {

        const documentContainer = this.closest('.document-container');
        const documentValue = JSON.parse(documentContainer.getAttribute('data-document').replace(/'/g, '"'));
        const productId = documentValue['name'];
        const button = document.getElementById("quantity-input-apply-"+ productId);
            button.innerText = "Apply!";
            button.style.background = "#1daede"
    });
});
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
let csrftoken = getCookie('csrftoken');

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
</script>
{%endblock%}