{% extends 'widgets/base.html' %}
{% block title %}
    {% if category_catalog == "All"%}
        Oliver Weber Shop Online | All products
    {% elif category_catalog == "Necklaces"%}
        Oliver Weber Shop| Pendants and Necklaces
    {% elif category_catalog == "Necklace"%}
        Oliver Weber Shop| Pendants and Necklaces
    {% elif category_catalog == "Colliers"%}
        Oliver Weber Shop| Pendants and Necklaces
    {% elif category_catalog == "Pendants"%}
        Oliver Weber Shop| Pendants and Necklaces| Oliver Weber Shop
    {% elif category_catalog == "Pearls"%}
        Oliver Weber Shop| Pearls
    {% elif category_catalog == "Accessories"%}
        Oliver Weber Shop Online| Jewelry and accessories
    {% elif category_catalog == "Pen"%}
        Oliver Weber Shop Online| Jewelry and accessories
    {% elif category_catalog == "Brooch"%}
        Oliver Weber Shop Online| Jewelry and accessories
    {% elif category_catalog == "Nailfile"%}
        Oliver Weber Shop Online| Jewelry and accessories
    {% elif category_catalog == "Ring"%}
        Oliver Weber Shop| Rings
    {% elif category_catalog == "All Earrings"%}
        Oliver Weber Shop| All Earrings
    {% elif category_catalog == "Earrings"%}
        Oliver Weber Shop| Earrings
    {% elif category_catalog == "Post Earrings"%}
        Oliver Weber Shop| Post Earrings
    {% elif category_catalog == "Studs"%}
        Oliver Weber Shop| Studs
    {% elif category_catalog == "Drops"%}
        Oliver Weber Shop| Drops
    {% elif category_catalog == "Hoops"%}
        Oliver Weber Shop| Hoops
    {% elif category_catalog == "Creole"%}
        Oliver Weber Shop| Creole
    {% elif category_catalog == "Clips"%}
        Oliver Weber Shop| Clips
    {% elif category_catalog == "Piercing"%}
        Oliver Weber Shop| Piercing
    {% elif category_catalog == "Pearl"%}
        Oliver Weber Shop| Pearls
    {% elif category_catalog == "Bracelets"%}
        Oliver Weber Shop| Bracelets
    {% elif category_catalog == "Bracelets"%}
        Oliver Weber Shop| Bracelets
    {% elif category_catalog == "Bangle"%}
        Oliver Weber Shop| Bangle
    {% elif category_catalog == "Chain"%}
        Oliver Weber Shop| Chains
    {% elif category_catalog == "Pearlchain"%}
        Oliver Weber Shop| Pearlchains
    {% elif category_catalog == "Anklet"%}
        Oliver Weber Shop| Anklets
    {% elif category_catalog == "Match"%}
        Oliver Weber Shop| Matches
    {% elif category_catalog == "Pen"%}
        Oliver Weber Shop Online| Jewelry and accessories
    {% elif category_catalog == "Key"%}
        Oliver Weber Shop Online| Jewelry and accessories
    {% elif category_catalog == "Extension"%}
        Oliver Weber Shop Online| Extension
    {% elif category_catalog == "UV"%}
        Oliver Weber Shop| UV
    {% elif category_catalog == "NotFound"%}
        Page is not found
    {% else %}
        Page is not found
    {% endif %}
{% endblock %}
{% block meta_description %}
{% if category_catalog == "All"%}
        All Oliver Weber's best selling products, get elegant jewelry, earrings, necklaces and chokers with rhinestones.
    {% elif category_catalog == "Necklaces"%}
        Pendants and necklaces with pearls and colored rhinestones. Elegant necklaces for women available in Oliver Weber's online store.
    {% elif category_catalog == "Necklace"%}
        Pendants and necklaces with pearls and colored rhinestones. Elegant necklaces for women available in Oliver Weber's online store.
    {% elif category_catalog == "Colliers"%}
        Pendants and necklaces with pearls and colored rhinestones. Elegant necklaces for women available in Oliver Weber's online store
    {% elif category_catalog == "Pendants"%}
        Pendants and necklaces with pearls and colored rhinestones. Elegant necklaces for women available in Oliver Weber's online store.
    {% elif category_catalog == "Pearls"%}
        Bracelets and bangles with chain, jewelry with pearls and colored rhinestones. Elegant bracelets for women available in Oliver Weber's online store.
    {% elif category_catalog == "Accessories"%}
        Jewelry, accessories, key rings, brooches... Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Pen"%}
        Jewelry, accessories, key rings, brooches... Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Brooch"%}
        Jewelry, accessories, key rings, brooches... Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Nailfile"%}
        Jewelry, accessories, key rings, brooches... Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Ring"%}
        Rings with pearls and colored rhinestones. Elegant ring for women available in Oliver Weber's online store.
    {% elif category_catalog == "All Earrings"%}
        Earrings for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Earrings"%}
        Earrings for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Post Earrings"%}
        Post Earrings for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Studs"%}
        Studs for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Drops"%}
        Drop Earrings for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Hoops"%}
        Hoops for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Creole"%}
        Creoles for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Clips"%}
        Clips for women, different designs, elegant sizes. Earrings for evening and office. Oliver Weber Collection.
    {% elif category_catalog == "Piercing"%}
        Jewelry, accessories, key rings, brooches... Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Pearl"%}
        Bracelets and bangles with chain, jewelry with pearls and colored rhinestones. Elegant bracelets for women available in Oliver Weber's online store.
    {% elif category_catalog == "Bracelets"%}
        Bracelets and bangles with chain, jewelry with pearls and colored rhinestones. Elegant bracelets for women available in Oliver Weber's online store.
    {% elif category_catalog == "Bracelets"%}
        Bracelets and bangles with chain, jewelry with pearls and colored rhinestones. Elegant bracelets for women available in Oliver Weber's online store.
    {% elif category_catalog == "Bangle"%}
        Bracelets and bangles with chain, jewelry with pearls and colored rhinestones. Elegant bracelets for women available in Oliver Weber's online store.
    {% elif category_catalog == "Chain"%}
        Bracelets and bangles with chain, jewelry with pearls and colored rhinestones. Elegant bracelets for women available in Oliver Weber's online store.
    {% elif category_catalog == "Pearlchain"%}
        Pearlchain for women. Elegant jewelry and accessories for women. Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Anklet"%}
        Anklets for women. Elegant jewelry and accessories for women. Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Match"%}
        Matches for women. Elegant jewelry and accessories for women. Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Pen"%}
        Jewelry, accessories, key rings, brooches... Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Key"%}
        Jewelry, accessories, key rings, brooches... Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "Extension"%}
        Extension and much more! Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "UV"%}
        UV boxes and much more! Find everything you are looking for in the Oliver Weber store.
    {% elif category_catalog == "NotFound"%}
        Page doesn't exist.
    {% endif %}
{% endblock %}
{% block content %}
{% load static %}
{% load i18n  %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catalog</title>
    <link rel="stylesheet"  href="{% static 'css/catalog.css' %}">
    <!-- Add this script tag to your HTML to include Firebase SDK -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static "js/product_cards.js" %}"></script>
    <script src="{% static "js/catalog/setupFilters.js" %}"></script>
    <script src="{% static "js/catalog/setupSliderFilter.js" %}"></script>
    <script src="{% static "js/productsTransmutation.js" %}"></script>
    <link rel="icon" href="{% static "images/icons/web-icon.png" %}" type="image/x-icon">

</head>
<body>
{% include 'widgets/navigation_bar.html' %}

<div class="everything" style="margin-top: 120px">
    <div class="filters-section">
        <div class="categories" id="categoriesPanel" style="display: none;">
            <div class="categories-label">
                {% trans "Categories" %}
                <i class="fas fa-chevron-right chevron"></i>
            </div>
            <ul class="categories-list">

            </ul>
        </div>
        <div class="collections" id="collectionsPanel" style="display: none;">
            <div class="collections-label">
                {% trans "Collections" %}
                <i class="fas fa-chevron-right chevron"></i>
            </div>
            <ul class="collections-list">

            </ul>
        </div>
        <div class="filters">
            <div class="filters-label"><div class="filters-label-title" id="filtersCollapsTrigger">{% trans "Filters" %}<i id="iconFiltersCollaps" class="fa-solid fa-plus"></i></div><hr></div><br>
            <div id="filtersPanel" class="filter-panel">
                <div class="filter-name">
                    <label for="contains-in-name">{% trans "Name, Product Article" %}</label>
                    <hr>
                    <input type="text" id="contains-in-name" placeholder="{% trans "Contains in name" %}..."><br>
                </div><br>
                <div class="filter-price">
                    <label for="slider-price">{% trans "Price" %}</label>
                    <hr>
                   <div class="range_container">
                        <div class="sliders_control">
                           <input id="fromSlider" type="range" value="0" min="0" max="800" step="5"/>
                           <input id="toSlider" type="range" value="800" min="0" max="800" step="5"/>
                        </div>
                        <div class="form_control">
                          <div class="form_control_container">
                              <span class="fromInput-text">{{ currency }}0</span>
                          </div>
                              <div class="form_control_container">
                                 <span class="toInput-text">{{ currency }}800</span>
                              </div>
                        </div>
                    </div>
                </div>
                <div class="filter-crystal-color">
                    {% trans "Crystal color" %}
                    <hr>

                    <div class="crystals">
                        <div id="crystal1">
                            <input class="crystal-checkbox" type="checkbox" id="checkbox1" name="checkbox1" value="Pink">
                            <label class="checkbox-label" for="checkbox1">Pink</label>
                        </div>
                        <div id="crystal2">
                            <input class="crystal-checkbox" type="checkbox" id="checkbox2" name="checkbox2" value="Red">
                            <label class="checkbox-label" for="checkbox2">Red</label>
                        </div>
                        <div id="crystal3">
                            <input class="crystal-checkbox" type="checkbox" id="checkbox3" name="checkbox3" value="Blue">
                            <label class="checkbox-label" for="checkbox3">Blue</label>
                        </div>
                    </div>
                    <div class="remove-filters-container" id="crystals">  <span class="remove-filters"><i class="fa-solid fa-close"></i> Reset this group</span></div>

                </div>
                <br>
                <div class="filter-plating">
                    {% trans "Plating material" %}
                    <hr>
                    <div class="platings">
                        <div id="plating1">
                            <input class="plating-checkbox" type="checkbox" id="checkboxPL1" name="checkboxPL1" value="Rhodium">
                            <label class="checkbox-label" for="checkboxPL1">Rhodium</label>
                        </div>
                        <div id="plating2">
                            <input class="plating-checkbox" type="checkbox" id="checkboxPL2" name="checkboxPL2" value="Gold">
                            <label class="checkbox-label" for="checkboxPL2">Gold</label>
                        </div>
                        <div id="plating3">
                            <input class="plating-checkbox" type="checkbox" id="checkboxPL3" name="checkboxPL3" value="Rose Gold">
                            <label class="checkbox-label" for="checkboxPL3">Rose Gold</label>
                        </div>
                        <div id="plating4">
                            <input class="plating-checkbox" type="checkbox" id="checkboxPL4" name="checkboxPL4" value="Without">
                            <label class="checkbox-label" for="checkboxPL4">Without</label>
                        </div>
                    </div>
                   <div class="remove-filters-container" id="platings">  <span class="remove-filters"><i class="fa-solid fa-close"></i> Reset this group</span></div>
                </div><br>
                <div class="filter-base">
                    {% trans "Base material" %}
                    <hr>
                    <div class="bases">
                        <div id="base1">
                            <input class="base-checkbox" type="checkbox" id="checkboxB1" name="checkboxB1" value="Steel">
                            <label class="checkbox-label" for="checkboxB1">Steel</label>
                        </div>
                        <div id="base2">
                            <input class="base-checkbox" type="checkbox" id="checkboxB2" name="checkboxB2" value="Steel Brass">
                            <label class="checkbox-label" for="checkboxB2">Steel Brass</label>
                        </div>
                    </div>

                    <div class="remove-filters-container" id="bases">  <span class="remove-filters"><i class="fa-solid fa-close"></i> Reset this group</span></div>
                </div><br>
                <div class="filter-size">
                    {% trans "Size" %}
                    <hr>
                    <div class="sizes">
                        <div id="size1">
                            <input class="size-checkbox" type="checkbox" id="checkboxS1" name="checkboxS1" value="S">
                            <label class="checkbox-label" for="checkboxS1">S</label>
                        </div>
                        <div id="size2">
                            <input class="size-checkbox" type="checkbox" id="checkboxS2" name="checkboxS2" value="M">
                            <label class="checkbox-label" for="checkboxS2">M</label>
                        </div>
                        <div id="size3">
                            <input class="size-checkbox" type="checkbox" id="checkboxS3" name="checkboxS3" value="L">
                            <label class="checkbox-label" for="checkboxS3">L</label>
                        </div>
                        <div id="size4">
                            <input class="size-checkbox" type="checkbox" id="checkboxS4" name="checkboxS4" value="XL">
                            <label class="checkbox-label" for="checkboxS4">XL</label>
                        </div>
                    </div>

                    <div class="remove-filters-container" id="sizes">  <span class="remove-filters"><i class="fa-solid fa-close"></i> Reset this group</span></div>
                </div>
            </div>
{#            <button id="submit-button">Submit filters</button>#}
        </div>
    </div>
    <div class="products-section">
        <div class="view-settings">
            <div class="select-per-page">

                <span>{% trans "Items per page" %}: </span>
                <select id="select-items-per-page">
                    <option>20</option>
                    <option>50</option>
                    <option>100</option>
                </select>
            </div>
            <div class="select-order">
                <span>{% trans "Order by" %}: </span>
                <select id="select-order">
                    <option>{% trans "Name" %}, asc</option>
                    <option>{% trans "Name" %}, desc</option>
                    <option>{% trans "Price" %}, asc</option>
                    <option>{% trans "Price" %}, desc</option>
                </select>
            </div>
        </div>
        <div>

        </div>
        <div class="products-grid">

        </div>

        <dialog id="product-card">

        </dialog>
        <dialog id="product-card-success" >

        </dialog>
        <br>
        <hr style="width: 94%; float:left">
        <div class="pages-container">
            <div class="semi">
                <div class="pages" id="pages">
                    <a id="previous-button" href=""><i class="fa-solid fa-chevron-left"></i>{% trans "Previous" %} </a>
                    <span id="current-page"> </span>
                    <a id="next-button" href="">{% trans "Next" %} <i class="fa-solid fa-chevron-right"></i></a>
                </div>
            </div>
            <div id="jump">
                <input id="page-number-input" type="number">
                <button id="button-jump-to">{% trans "Jump" %}</button>
            </div>
      </div>
</div>
</div>
{% include "widgets/overlay.html" %}
{% include "widgets/footer.html" %}
</body>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';

    import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    var firebaseConfig = {
        apiKey: "AIzaSyAM0wDc_WO0wP3-_TPRPLENZDIHbezH7U4",
        authDomain: "flutterapp-fd5c3.firebaseapp.com",
        projectId: "flutterapp-fd5c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.addEventListener("DOMContentLoaded", async function () {
        showOverlay();

        itemsPerPage = Number(document.getElementById('select-items-per-page').value);

        let unfilteredItems = await fetchAllItems(); // Fetch all items on load

        favouriteItems = await fetchFavouriteItems("{{ user.email }}");

        stones = await fetchStones();
        console.log(stones);

        allItems = productsTransmutation(unfilteredItems, price_category, sale, stones);

        total_pages = Math.ceil(allItems.length / itemsPerPage);

        updatePage();

        buildUpPages();
        changePage(currentPage);

        constructCategories();
        constructCollections();
        const categoriesLabel = document.querySelector('.categories-label');
        const categories = document.querySelector('.categories');

        categoriesLabel.addEventListener('click', function() {
            categories.classList.toggle('collapsed'); // Переключить класс для анимации

        });
        const collectionsLabel = document.querySelector('.collections-label');
        const collections = document.querySelector('.collections');
        collectionsLabel.addEventListener('click', function() {
            collections.classList.toggle('collapsed'); // Переключить класс для анимации

        });
        const static_folder = "{% static "images/crystals" %}";

        constructFilters(allItems, filters_dict, static_folder);

        setupFiltersEventListeners('.plating-checkbox', platingFilters);
        setupFiltersEventListeners('.base-checkbox', baseFilters);
        setupFiltersEventListeners('.size-checkbox', sizeFilters);

        applyFilters();
        updateURL();
        hideOverlay();
        responsiveLayout();
    });
    function responsiveLayout(){
        let mql = window.matchMedia("(max-width: 769px)");
        if( mql.matches) {
            document.getElementById('categoriesPanel').classList.toggle('collapsed');
            document.getElementById('collectionsPanel').classList.toggle('collapsed');
            document.getElementById('filtersPanel').classList.toggle('collapsed-filters');
            document.getElementById('iconFiltersCollaps').classList.remove('fa-plus');
            document.getElementById('iconFiltersCollaps').classList.add('fa-minus');
        }

    }
    document.getElementById('filtersCollapsTrigger').addEventListener('click', function() {
       document.getElementById('filtersPanel').classList.toggle('collapsed-filters');
       if(document.getElementById('iconFiltersCollaps').classList.contains('fa-plus')){
            document.getElementById('iconFiltersCollaps').classList.remove('fa-plus');
            document.getElementById('iconFiltersCollaps').classList.add('fa-minus');
       }else{
            document.getElementById('iconFiltersCollaps').classList.remove('fa-minus');
            document.getElementById('iconFiltersCollaps').classList.add('fa-plus');
       }
    });
let sale = {{ sale|safe }};
const price_category = "{{ category|safe }}";
const show_quantities = "{{ show_quantities|safe }}" !== "False";
let itemsPerPage = 20;
let order_name = "Name";
let order_type = "asc";
let number_of_documents;
let currentPage = 1;
let total_pages = 1;
let allItems = [];
let favouriteItems = [];
let filteredItems = [];
let filters = [];
let stones = {};
let stones_reversed = {};
let platingFilters =  "{{ plating_catalog }}" ? ["{{ plating_catalog|safe }}"] : [];
let baseFilters = "{{ base_catalog }}" ? ["{{ base_catalog|safe }}"] : [];
let stoneFilters = [];
let sizeFilters = [];
let subcat = {"Necklaces": ["Necklace","Chain","Pearlchain", "Pendant", "Collier"], "All Earrings": ["Earrings","Post Earrings", "Clip", "Hoop"], "Bracelets":["Bracelet","Bangle", "Anklet"], "Accessories":["Piercing", "Nailfile", "Pen","Key","Brooch"]}
let category = "{{ category_catalog|safe}}" || "All";
let collection_catalog = "{{ collection_catalog|safe}}" || "";
let categories = [""];
let all_crystals = [];
let all_platings = [];
let all_bases = [];

function buildUpPages() {
    const pagesContainer = document.getElementById('current-page');
    let pagesToShow = document.createDocumentFragment(); // Use a document fragment to hold elements before inserting them into the DOM

    function addPageLink(page, isCurrentPage) {
        const pageElement = document.createElement('a');
        if (isCurrentPage) {
            const boldText = document.createElement('b');
            boldText.textContent = page;
            if(currentPage === 1){
                boldText.style.padding = '10px';
            }
            pagesToShow.appendChild(boldText);
        } else {
            pageElement.href = "";
            pageElement.textContent = page;
            pageElement.addEventListener('click', function(event) {
                event.preventDefault();
                changePage(page);
            });
            pagesToShow.appendChild(pageElement);
        }
        pagesToShow.appendChild(document.createTextNode(' ')); // Add space between links
    }

    function addEllipsis() {
        pagesToShow.appendChild(document.createTextNode('... '));
    }

    if (total_pages <= 5) {
        for (let i = 1; i <= total_pages; i++) {
            addPageLink(i, i === currentPage);
        }
    } else {
        addPageLink(1, currentPage === 1);

        if (currentPage > 3) {
            addEllipsis();
        }

        let startPage = Math.max(2, currentPage - 1);
        let endPage = Math.min(currentPage + 1, total_pages - 1);

        if (currentPage === 1) {
            endPage = Math.min(3, total_pages - 1);
        } else if (currentPage === total_pages) {
            startPage = Math.max(total_pages - 2, 2);
        }

        for (let i = startPage; i <= endPage; i++) {
            addPageLink(i, i === currentPage);
        }

        if (currentPage < total_pages - 2) {
            addEllipsis();
        }

        addPageLink(total_pages, currentPage === total_pages);
    }

    // Clear the current content and append the new set of page links
    pagesContainer.innerHTML = '';
    pagesContainer.appendChild(pagesToShow);
}
function changePage(page) {
    if(page === 1){
        document.getElementById("previous-button").style.display = 'none';
    }
    else{
        document.getElementById("previous-button").style.display = 'block';
    }
    if(page === total_pages){
        document.getElementById("next-button").style.display = 'none';
    }
    else{
        document.getElementById("next-button").style.display = 'block';
    }
    currentPage = page;
    updatePage(); // Assuming you have this function implemented to refresh the content based on the current page

    buildUpPages();
}


let synonyms = {
    "All": "{{ _("All")|escapejs }}",
    "Necklaces": "{{ _("Necklaces")|escapejs }}",
    "All Earrings": "{{ _("Earrings")|escapejs }}",
    "Earrings": "{{ _("Earrings")|escapejs }}",
    "Bracelets": "{{ _("Bracelets")|escapejs }}",
    "Accessories": "{{ _("Accessories")|escapejs }}",
    "Pendant": "{{ _("Pendants")|escapejs }}",
    "Chain": "{{ _("Chains")|escapejs }}",
    "Collier": "{{ _("Colliers")|escapejs }}",
    "Pearlchain": "{{ _("Pearlchains")|escapejs }}",
    "Necklace": "{{ _("Necklaces")|escapejs }}",
    "Post Earrings": "{{ _("Post earrings")|escapejs }}",
    "Hoop": "{{ _("Hoops")|escapejs }}",
    "Creole": "{{ _("Creoles")|escapejs }}",
    "Clip": "{{ _("Clips")|escapejs }}",
    "Piercing": "{{ _("Piercings")|escapejs }}",
    "Bracelet": "{{ _("Bracelets")|escapejs }}",
    "Bangle": "{{ _("Bangles")|escapejs }}",
    "Anklet": "{{ _("Anklets")|escapejs }}",
    "Ring": "{{ _("Rings")|escapejs }}",
    "Match": "{{ _("Matches")|escapejs }}",
    "Pen": "{{ _("Pens")|escapejs }}",
    "Key": "{{ _("Keys")|escapejs }}",
    "Brooch": "{{ _("Brooches")|escapejs }}",
    "Nailfile": "{{ _("Nailfiles")|escapejs }}",
    "Extension": "{{ _("Extensions")|escapejs }}",
    "UV": "{{ _("UV")|escapejs }}"
}
let categories_codes = {
    "All": "0",
    "Necklaces": "3",
    "All Earrings": "8",
    "Earrings": "208",
    "Bracelets": "9",
    "Accessories": "4",
    "Pendant": "275",
    "Chain": "40",
    "Collier": "74",
    "Pearlchain": "240",
    "Necklace": "203",
    "Post Earrings": "2208",
    "Hoop": "27",
    "Creole": "227",
    "Clip": "228",
    "Piercing": "229",
    "Bracelet": "209",
    "Bangle": "39",
    "Anklet": "79",
    "Ring": "7",
    "Match": "2000",
    "Pen": "2001",
    "Key": "2002",
    "Brooch": "67",
    "Nailfile": "267",
    "Extension": "2003",
    "UV": "2004",
    "undefined": "404",
    "NotFound": "404",
}
let categories_code_to_name = {
    "0": "all",
    "3": "necklaces",
    "203": "necklace",
    "74": "colliers",
    "274": "pendants",
    "76": "pearls",
    "61": "rosegold-necklaces",
    "62": "gold-necklaces",
    "63": "rhodium-necklaces",
    "64": "sterling-silver-necklaces",
    "65": "zircon-necklaces",
    "80": "stainless-steel-necklaces",
    "4": "accessories",
    "66": "pen",
    "67": "brooch",
    "267": "nailfile",
    "7": "rings",
    "20": "rosegold-rings",
    "21": "gold-rings",
    "22": "rhodium-rings",
    "23": "sterling-silver-rings",
    "24": "zircon-rings",
    "81": "stainless-steel-rings",
    "8": "earrings",
    "208": "simple-earrings",
    "2208": "post-earrings",
    "25": "studs",
    "26": "drops",
    "27": "hoops",
    "227": "creole",
    "228": "clips",
    "229": "piercing",
    "28": "pearl",
    "34": "rosegold-earrings",
    "35": "gold-earrings",
    "36": "rhodium-earrings",
    "37": "sterling-silver-earrings",
    "38": "zircon-earrings",
    "82": "stainless-steel-earrings",
    "9": "bracelets",
    "209": "bracelets",
    "39": "bangle",
    "40": "chain",
    "240": "pearlchain",
    "48": "rosegold-bracelets",
    "50": "rhodium-bracelets",
    "51": "sterling-silver-bracelets",
    "52": "zircon-bracelets",
    "83": "stainless-steel-bracelets",
    "79": "anklets",
    "2000": "match",
    "2001": "pen",
    "2002": "key",
    "84": "stainless-steel-anklets",
    "2003": "extensions",
    "2004": "uv",
    "404": "not-found"
}
let synonyms_collections = {
        "All": "{{ _("All")|escapejs }}",
        "Winter_2025" : "Winter 2025"
    }
let translations_categories = {
    "Earrings": "{{ _("Earrings")|escapejs }}",
    "Pendant": "{{ _("Pendant")|escapejs }}",
    "Chain": "{{ _("Chain")|escapejs }}",
    "Collier": "{{ _("Collier")|escapejs }}",
    "Pearlchain": "{{ _("Pearlchain")|escapejs }}",
    "Necklace": "{{ _("Necklace")|escapejs }}",
    "Post Earrings": "{{ _("Post earrings")|escapejs }}",
    "Hoop": "{{ _("Hoop")|escapejs }}",
    "Creole": "{{ _("Creole")|escapejs }}",
    "Clip": "{{ _("Clip")|escapejs }}",
    "Piercing": "{{ _("Piercing")|escapejs }}",
    "Bracelet": "{{ _("Bracelet")|escapejs }}",
    "Bangle": "{{ _("Bangle")|escapejs }}",
    "Anklet": "{{ _("Anklet")|escapejs }}",
    "Ring": "{{ _("Ring")|escapejs }}",
    "Match": "{{ _("Match")|escapejs }}",
    "Pen": "{{ _("Pen")|escapejs }}",
    "Key": "{{ _("Key")|escapejs }}",
    "Brooch": "{{ _("Brooch")|escapejs }}",
    "Nailfile": "{{ _("Nailfile")|escapejs }}",
    "Extension": "{{ _("Extension")|escapejs }}",
    "UV": "{{ _("UV")|escapejs }}"
}

let filters_dict = {
    "Default": "{{ _("Default")|escapejs }}",
    "Rhodium": "{{ _("Rhodium")|escapejs }}",
    "Gold": "{{ _("Gold")|escapejs }}",
    "Rosegold": "{{ _("Rosegold")|escapejs }}",
    "Without": "{{ _("Without")|escapejs }}",
    "Steel": "{{ _("Steel")|escapejs }}",
    "Brass": "{{ _("Brass")|escapejs }}",
    "Silver": "{{ _("Silver")|escapejs }}",
}

function constructCategories(){
    const categories_div = document.querySelector('.categories');
    const categoriesList = document.querySelector('.categories-list');
    categoriesList.innerHTML = ''; // Clear existing list items

    // Assuming 'subcat' is defined globally
    const generalCategories = Object.keys(subcat);
    const subCategories = new Set([].concat(...Object.values(subcat)));

    let categories = allItems.reduce((acc, item) => {
        if (!acc.includes(item.category) && !subcat.hasOwnProperty(item.category)) {
            acc.push(item.category);
        }
        return acc;
    }, []);

    const categoryList = ["All", ...generalCategories, ...categories];

    categoryList.forEach(categoryVar => {

        if (subCategories.has(categoryVar)) return; // Skip adding sub-categories here

        const li = document.createElement('li');

        const categorySpan = createCategorySpan(categoryVar);
        const categoryDivForLi = document.createElement('div');
        categoryDivForLi.classList.add('container-subcategories');
        categoryDivForLi.appendChild(categorySpan);
        li.appendChild(categoryDivForLi);
        categoriesList.appendChild(li);

        if (subcat.hasOwnProperty(categoryVar)) {
            const chevron = createChevron();
            categoryDivForLi.appendChild(chevron);
            const ul = createSubCategoryList(subcat[categoryVar]);
            li.appendChild(ul);

            setupChevronToggle(chevron, ul);
        }

        setupCategoryClickListener(categorySpan);
    });

    categories_div.style.display = 'block';
}

function constructCollections(){
    const collections_div = document.querySelector('.collections');
    const collectionsList = document.querySelector('.collections-list');
    collectionsList.innerHTML = ''; // Clear existing list items

    // Assuming 'subcat' is defined globally

    let collections = allItems.reduce((acc, item) => {
        if (!acc.includes(item.collection)) {
            acc.push(item.collection);
        }
        return acc;
    }, []);
    const index = collections.indexOf("");
    if (index > -1) { // only splice array when item is found
      collections.splice(index, 1); // 2nd parameter means remove one item only
    }
    const collectionList = ["All", ...collections];
    collectionList.forEach(collectionVar => {

        const li = document.createElement('li');

        const collectionSpan = createCollectionSpan(collectionVar);
        const collectionDivForLi = document.createElement('div');
        collectionDivForLi.appendChild(collectionSpan);
        li.appendChild(collectionDivForLi);
        collectionsList.appendChild(li);

        setupCollectionClickListener(collectionSpan);
    });

    collections_div.style.display = 'block';
}
function createCollectionSpan(currentCollection) {
    const span = document.createElement('span');
    span.textContent = synonyms_collections[currentCollection];
    span.setAttribute("data-collection-name", currentCollection);
    span.className = 'collection-name';

    if (currentCollection === collection_catalog) span.style.fontWeight = "600";
    return span;
}
function setupCollectionClickListener(span) {
    span.addEventListener('click', () => {
        document.querySelectorAll('.collections-list li span').forEach(li => li.style.fontWeight = "");
        collection_catalog = span.getAttribute("data-collection-name"); // Assuming 'category' is a global variable
        span.style.fontWeight = "600";
        const newUrl = `?collection=${encodeURIComponent(collection_catalog)}`;
        history.pushState({path: newUrl}, '', newUrl);

        applyFilters(); // Call the applyFilters function
        updateURL();
    });
}
function createCategorySpan(currentCategory) {
    const span = document.createElement('span');
    span.textContent = synonyms[currentCategory];
    span.setAttribute("data-category-name", currentCategory);
    span.setAttribute("category-id", categories_codes[currentCategory]);
    span.className = 'category-name';
    console.log(currentCategory);

    if (currentCategory === category) span.style.fontWeight = "600";
    return span;
}

function createChevron() {
    const chevron = document.createElement('i');
    chevron.className = 'fa-solid fa-chevron-down';
    chevron.style.cursor = "pointer";
    return chevron;
}

function createSubCategoryList(subCategories) {

    const ul = document.createElement('ul');
    ul.className = 'sub-category-list'; // Assign class for styling
    subCategories.forEach(sub => {
        const subLi = document.createElement('li');
        const subSpan = document.createElement('span');
        subSpan.setAttribute("data-category-name", sub);
        subSpan.textContent = synonyms[sub];
        subLi.appendChild(subSpan);
        ul.appendChild(subLi);
        setupCategoryClickListener(subSpan);
    });
    return ul;
}

function setupChevronToggle(chevron, ul) {
    chevron.addEventListener('click', () => {
        const isOpen = ul.style.height !== '0px' && ul.style.height !== '';
        if (isOpen) {
            ul.style.height = '0'; // Close the ul by setting height to 0
            chevron.className = 'fa-solid fa-chevron-down';
        } else {
            ul.style.height = `${ul.scrollHeight}px`; // Open the ul by setting height to its natural height
            chevron.className = 'fa-solid fa-chevron-up';
        }
    });
}

function setupCategoryClickListener(span) {
    span.addEventListener('click', () => {
        document.querySelectorAll('.categories-list li span').forEach(li => li.style.fontWeight = "");
        category = span.getAttribute("data-category-name"); // Assuming 'category' is a global variable
        span.style.fontWeight = "600";
        {#const newUrl = `?category=${encodeURIComponent(category)}`;#}
        {#history.pushState({path: newUrl}, '', newUrl);#}

        applyFilters(); // Call the applyFilters function
        updateURL();
    });
}
function constructCrystals(items, filters_dict, static_folder) {
    let uniqueStones = new Set();
    let stones_all = ['241', '327', '515', '260', '288', '501', '208', '227', '220', 'DAR', '276', '379', '205', '277', '922', '280', '243', '204', '291', '236', '215', '228', '502', '207', '203', '219', '206', '147', '0', '394', '266', '289', '539', '542', '920', '398', '142', '229', '214', '226', '209', 'GSHA', '390', '263', '391', '267', '292', '212', '257', '202', '371', '262', '283', '211', '319', '261', '238', '362', '265', '223', '508', 'CRE', '234', '395', '361', '285', '001', 'AB'];
    let stones_names = []
    for (let i = 0; i < stones_all.length; i++) {
      stones_names[i] = stones[stones_all[i]];
    }
    console.log("THI IS ");
    console.log(stones_all);
    if (Array.isArray(items) && items.length > 0) {
        items.forEach(document => {
            if (document.platings) { // Проверка, что у document есть platings
                Object.values(document.platings).forEach(plating => {
                    if (plating.stones) { // Проверка, что у plating есть stones
                        Object.keys(plating.stones).forEach(stoneCategory => {
                            if (stones_names.includes(stoneCategory)) { // Проверяем, есть ли stoneCategory в stones
                                uniqueStones.add(stoneCategory);
                            }
                        });
                    }
                });
            }
        });
    } else {
        console.log("Items is either empty or not an array.");
    }

    createCrystalElements('crystals',Array.from(uniqueStones), 'crystal', filters_dict, static_folder);
}
function createCrystalElements(containerClass, itemsArray, prefix, filters_dict, static_folder) {
    const container = document.querySelector(`.${containerClass}`);
    container.innerHTML = ''; // Clear existing content

    // Create a div to hold the images in a grid
    const grid = document.createElement('div');
    grid.className = 'crystal-grid';
    let imagesLoaded = 0;
    // Loop through images and create an img element within a div for each
    itemsArray.forEach((item, index) => {
                const img = new Image();
                img.width = 20;
                img.height = 20;
                img.src = `${static_folder}/${stones_reversed[item]}.png`;
                img.alt = `Crystal ${index + 1}`;
                img.className = 'crystal-image';

                img.onload = () => {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'crystal-container';
                    imgDiv.setAttribute('data-value', item); // Set the crystal number

                    imgDiv.appendChild(img);
                    grid.appendChild(imgDiv);
                    imagesLoaded++;

                    // Check if all images are loaded
                    if (imagesLoaded === itemsArray.length) {
                        // Apply the honeycomb layout

                        // Set up click event listeners for the crystals
                        setupCrystalClickListeners(stoneFilters);
                    }
                    // Add event listener to each image
                    // imgDiv.addEventListener('click', function() {
                    //     handleCrystalClick(item, filters_dict);
                    // });
                };
            });

            // Append the grid to the container
            container.appendChild(grid);

            // Apply the honeycomb layout
            applyHoneycombLayout(grid);
        }

// Function to apply honeycomb layout
function applyHoneycombLayout(grid) {
    const containers = grid.querySelectorAll('.crystal-container');
    containers.forEach((container, index) => {
        if (Math.floor(index / 4) % 3 === 1) {
            container.style.marginLeft = '30px'; // Adjust as needed for your layout
        } else {
            container.style.marginLeft = '0';
        }
    });
}
// Function to simulate changing the page (you might have your actual logic to fetch/update content here)
function setupCrystalClickListeners(filtersArray) {
    const containers = document.querySelectorAll('.crystal-container');

    containers.forEach(container => {
        container.addEventListener('click', function() {
            const remove_button = this.parentElement.parentElement.parentElement.querySelector('.remove-filters-container');
            let selectedValue = this.getAttribute('data-value');
            // Remove 'selected' class from all containers
            containers.forEach(c => {
                c.children[0].classList.remove('selected');

            });

            // Add 'selected' class to the clicked container
            container.children[0].classList.add('selected');
            filtersArray.length = 0;
            remove_button.style.display = "block";
            filtersArray.push(selectedValue);
            // Perform the required action when a crystal is clicked
            console.log(`Crystal clicked: ${container.getAttribute('data-value')}`);
            // Add your filtering logic here
            applyFilters();
            updateURL();
        });
    });
}

function setupFiltersEventListeners(checkboxClassName, filtersArray) {
    document.querySelectorAll(checkboxClassName).forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll(checkboxClassName);
            const remove_button = this.parentElement.parentElement.parentElement.querySelector('.remove-filters-container');
            const label = this.parentElement.querySelector('label');
            let textValue = this.value;

            if (this.checked) {
                toggleOffUnnecessaryCheckboxes(checkboxes, textValue);
                filtersArray.length = 0; // Clear the filters array
                remove_button.style.display = "block";
                label.style.fontWeight = "600";
                filtersArray.push(textValue);
            } else {
                filtersArray.splice(filtersArray.indexOf(textValue), 1);
                if (filtersArray.length === 0) {
                    remove_button.style.display = "none"; // Hide remove button if filters array is empty
                }
                label.style.fontWeight = "";
            }

            applyFilters();
            updateURL();
        });
    });
    document.querySelectorAll(checkboxClassName).forEach(checkbox => {
        if (filtersArray.includes(checkbox.value)) {
            // Programmatically check the checkbox without triggering the event
            checkbox.checked = true;

            // Now manually trigger the change event
            let event = new Event('change', {
                'bubbles': true,
                'cancelable': true
            });
            checkbox.dispatchEvent(event);
        }
    });
}
function updateURL() {
    const currentUrl = new URL(window.location.href);

    // Извлекаем языковой код из текущего пути
    const pathSegments = currentUrl.pathname.split('/').filter(segment => segment); // Убираем пустые сегменты
    const languageCode = pathSegments[0]; // Считаем, что первый сегмент пути — это языковой код
    let categoryPath = '';

    // Проверяем, если указан category, добавляем его к пути
    if (category) {

        let code = categories_codes[category.toString()];
        if(!code) code="404";
        let cat_name_url = code + "-" + categories_code_to_name[code];
        // Если в URL уже есть категория, заменяем её
        if (pathSegments[1]) {
            pathSegments[1] = cat_name_url;
        } else {
            // Если категории нет, добавляем новую
            pathSegments.push(cat_name_url);
        }
        categoryPath = pathSegments.slice(0, 2).join('/');
    } else {
        // Если category не указан, оставляем текущий путь
        categoryPath = pathSegments.join('/');
    }

    // Формируем базовый URL с текущим языковым кодом и категорией
    const baseUrl = `${window.location.protocol}//${window.location.host}/${categoryPath}`;

    // Создаем и заполняем queryParams параметрами фильтров
    const queryParams = new URLSearchParams();
    if (collection_catalog) {
        queryParams.set('collection', collection_catalog);
    }
    if (baseFilters.length > 0) {
        queryParams.set('base', baseFilters.join(','));
    }
    if (platingFilters.length > 0) {
        queryParams.set('plating', platingFilters.join(','));
    }
    if (stoneFilters.length > 0) {
        queryParams.set('crystal', stoneFilters.join(','));
    }
    if (sizeFilters.length > 0) {
        queryParams.set('size', sizeFilters.join(','));
    }

    // Обновляем URL с использованием history.pushState
    const newUrl = queryParams.toString() ? `${baseUrl}?${queryParams.toString()}` : baseUrl;
    history.pushState({}, '', newUrl);
}
function toggleOffUnnecessaryCheckboxes(checkboxes, currentValue ){
    checkboxes.forEach(checkbox => {
        if (checkbox.value !== currentValue) {
            checkbox.checked = false;
            checkbox.parentElement.querySelector('label').style.fontWeight = "";
        }
    });
}
document.querySelectorAll('.remove-filters-container').forEach(container=> {
    container.addEventListener('click', function (){
       if(container.id === "platings"){
            platingFilters.length = 0;
            const platingCheckboxes = document.querySelectorAll('.plating-checkbox');
            platingCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.querySelector('label').style.fontWeight = "";
            });
            removeQueryParam('plating');
       }
       else if(container.id === "sizes"){
            sizeFilters.length = 0;
            const sizesCheckboxes = document.querySelectorAll('.size-checkbox');
            sizesCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.querySelector('label').style.fontWeight = "";
            });
            removeQueryParam('size');
       }
       else if(container.id === "bases"){
            baseFilters.length = 0;
            const baseCheckboxes = document.querySelectorAll('.base-checkbox');
            baseCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.querySelector('label').style.fontWeight = "";
            });
            removeQueryParam('base');
       }
       else if(container.id === "crystals"){
            stoneFilters.length = 0;
            const crystal_checkboxes = document.querySelectorAll('.crystal-checkbox');
            crystal_checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.querySelector('label').style.fontWeight = "";
            });
            const crystal_type_select = document.querySelector('.crystal-select');
            if (crystal_type_select) {
        crystal_type_select.selectedIndex = 0; // Reset to the first option
    }
            removeQueryParam('crystal');
       }
       this.style.display = "none";
       applyFilters();

    });
});


function removeQueryParam(param) {
    const baseUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
    const queryParams = new URLSearchParams(window.location.search);

    // Remove the specific query parameter
    queryParams.delete(param);

    // Update the URL without reloading the page
    const newUrl = queryParams.toString() ? `${baseUrl}?${queryParams.toString()}` : baseUrl;
    history.pushState({}, '', newUrl);
}



document.getElementById('contains-in-name').addEventListener('input', applyFilters);

const fromSlider = document.querySelector('#fromSlider');
const toSlider = document.querySelector('#toSlider');
const fromInputText = document.querySelector('.fromInput-text');
const toInputText = document.querySelector('.toInput-text');
fillSlider(fromSlider, toSlider, '#C6C6C6', '#003665', toSlider);
setToggleAccessible(toSlider);

fromSlider.oninput = () => controlFromSlider(fromSlider, toSlider, fromInputText, currency);
toSlider.oninput = () => controlToSlider(fromSlider, toSlider, toInputText, currency);

fromSlider.addEventListener('change', applyFilters);
toSlider.addEventListener('change', applyFilters);

async function fetchAllItems() {
    const itemsQuery1 = query(collection(db, "item"), where("quantity", ">", 0));

    // Second query: where pre_order is true
    const itemsQuery2 = query(collection(db, "item"), where("pre_order", "==", true));

    // Fetch both queries in parallel
    const [querySnapshot1, querySnapshot2] = await Promise.all([
        getDocs(itemsQuery1),
        getDocs(itemsQuery2)
    ]);

    // Get the data from both queries and combine the results
    const items1 = querySnapshot1.docs.map(doc => doc.data());
    const items2 = querySnapshot2.docs.map(doc => doc.data());

    // Combine the two arrays and return unique items if needed
    // Optionally, you can filter out duplicates if there are overlapping items
    return [...items1, ...items2];
}
async function fetchFavouriteItems(userEmail) {
    const favouritesQuery = query(collection(db, "Favourites"), where("email", "==", userEmail));
    const querySnapshot = await getDocs(favouritesQuery);
    return querySnapshot.docs.map(doc => doc.data());
}
async function fetchStones() {
    const stonesQuery = query(collection(db, "Stones")); // Запрос к коллекции Stones
    const querySnapshot = await getDocs(stonesQuery);

    // Преобразуем документы в объект { "id": "name" }
    const all_stones = {};
    querySnapshot.docs.forEach(doc => {
        const data = doc.data();
        if (data.id && data.name) { // Убедимся, что данные существуют
            all_stones[data.id] = data.name;
        }
    });
    querySnapshot.docs.forEach(doc => {
        const data = doc.data();
        if (data.id && data.name) { // Убедимся, что данные существуют
            stones_reversed[data.name] = data.id;
        }
    });

    return all_stones;
}
function paginateItems(items, pageNumber, pageSize) {
    const startIndex = (pageNumber - 1) * pageSize;
    return items.slice(startIndex, startIndex + pageSize);
}

function filterItems(items, pageNumber, pageSize) {
    const startIndex = (pageNumber - 1) * pageSize;
    return items.slice(startIndex, startIndex + pageSize);
}

function displayCurrentPage(items) {
    const productsGrid = document.querySelector('.products-grid');
    productsGrid.innerHTML = '';

    let vocabulary_base =  {{ vocabulary|safe }};
    console.log(vocabulary_base);
    let vocabulary = Object.assign(vocabulary_base, translations_categories, filters_dict);

    let itemId= 0;
    items.forEach((item) => {
        const productContainer = document.createElement('div');
        productContainer.className = 'product-container';
        productContainer.id = `product-${item.name}`;
        productContainer.setAttribute('data-id', itemId);

        productContainer.addEventListener('click', () => {
            const favouriteItem = favouriteItems.find(item_fav => item_fav.name === item.name); // Assuming `item.name` is the name of your current item

// Check if the item was found in the favourites

            let itemIsFavourite = Boolean(favouriteItem);
            if(filteredItems.length === 0){
                generateDialogContent(`${item.name}`, allItems, currency, show_quantities, "{% url "add_from_catalog" %}", vocabulary, getCookie('csrftoken'), "{% url "cart" %}", itemIsFavourite, "{{ user.is_authenticated|safe }}");
            }
            else{
                if(filteredItems[0] === "No items found"){
                    generateDialogContent(`${item.name}`, allItems, currency, show_quantities, "{% url "add_from_catalog" %}", vocabulary, getCookie('csrftoken'), "{% url "cart" %}", itemIsFavourite, "{{ user.is_authenticated|safe }}");

                }
                else {
                     generateDialogContent(`${item.name}`, filteredItems, currency, show_quantities, "{% url "add_from_catalog" %}", vocabulary, getCookie('csrftoken'), "{% url "cart" %}", itemIsFavourite,  "{{ user.is_authenticated|safe}}");

                }
            }
            });

        // Create the image section
        const imgSection = document.createElement('div');
        imgSection.className = 'img-section';

        const div_pre_order_icon = document.createElement('div');
        const pre_order_icon = document.createElement('img');
        pre_order_icon.className = 'icon-pre-order';
        pre_order_icon.src = "{% static "icons/pre-order-icon.webp" %}";
        div_pre_order_icon.appendChild(pre_order_icon);

        const imgWrapper = document.createElement('div');
        imgWrapper.className = 'img-wrapper';
        const img = document.createElement('img');
        img.src = item.preview_image;
        img.width = 115;
        img.height = 115;
        img.style.borderRadius = '10px';

        const iconContainer = document.createElement('div');
        iconContainer.className = 'icon-container';

        const heartIconContainer = document.createElement('div');
        heartIconContainer.className = 'heart-icon-container';
        const favouriteItem = favouriteItems.find(item_fav => item_fav.name === item.name); // Assuming `item.name` is the name of your current item

// Check if the item was found in the favourites

        const itemIsFavourite = Boolean(favouriteItem); // Converts the result to a boolean

        heartIconContainer.innerHTML = itemIsFavourite ?
        `<i class="rts" data-size="24" data-color="#000000" style="width: 24px; height: 24px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="width: 24px; height: 24px;"><path d="M14.05,6.72C8.17.2,2.57,7.54,3.67,11.76,5.56,19,14.05,23.57,14.05,23.57s7.74-4.16,10.39-11.81C25.86,7.64,20.24.13,14.05,6.72Z" style="fill:#000000;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px"></path></svg></i>` :
        `<i class="rts" data-size="24" data-color="#000000" style="width: 24px; height: 24px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="width: 24px; height: 24px;"><path d="M14.05,6.72C8.17.2,2.57,7.54,3.67,11.76,5.56,19,14.05,23.57,14.05,23.57s7.74-4.16,10.39-11.81C25.86,7.64,20.24.13,14.05,6.72Z" style="fill:none;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px"></path></svg></i>`; // Example with FontAwesome

        // Adding your new icon
        const newIconContainer = document.createElement('div');
        newIconContainer.className = 'new-icon-container';
        newIconContainer.innerHTML = `<i class="rts" data-size="24" data-color="#000000" style="width: 26px; height: 26px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="width: 24px; height: 24px;"><path d="M21.46,26H6.54C4,26,4,23.86,4,22.46V2H24V22.46C24,23.86,24,26,21.46,26Z" style="fill:none;stroke:#000000;stroke-miterlimit:10;stroke-width:2px"></path><path d="M10,8v.78c0,2.68,1.8,4.88,4,4.88s4-2.19,4-4.88V8" style="fill:none;stroke:#000000;stroke-miterlimit:10;stroke-width:2px"></path></svg></i>`;


        heartIconContainer.addEventListener('mouseenter', (event) => {
            const favouriteItem = favouriteItems.find(item_fav => item_fav.name === item.name); // Assuming `item.name` is the name of your current item
            const isFavBefore = Boolean(favouriteItem); // Converts the result to a boolean
            let message_fav = isFavBefore ? "{{ _("Remove from favorites")|escapejs }}" : "{{ _("Add to favorites")|escapejs }}";

            showTooltip(event, message_fav);
        });
        heartIconContainer.addEventListener('click', async (event) => {
            const favouriteItem = favouriteItems.find(item_fav => item_fav.name === item.name); // Assuming `item.name` is the name of your current item
            const isFavBefore = Boolean(favouriteItem); // Converts the result to a boolean

            // Stop the event from propagating to other elements
            event.stopPropagation();
            try {
                // Replace `yourItemId` with the actual item ID or any identifier you use
                const response = await fetch('{% url "change_favorite_state" %}', {
                    method: 'POST', // or 'DELETE' if removing from favorites
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),

                        // Include other headers as needed, like authorization tokens
                    },
                    body: JSON.stringify({item: JSON.stringify(item), "alreadyFavourite": isFavBefore ? "true":"false"}),
                });

                if (!response.ok) throw new Error('Network response was not ok.');

                // Assuming the backend responds with the updated favorite status
                const data = await response.json();
                const isFavourite = data.isFavourite === "true";
                const itemToAddOrRemove = JSON.parse(data.item); // Assuming this is an object {name_id: "someId", ...}
                const existingTooltip = document.querySelector('.custom-tooltip');
                if (existingTooltip) {
                    existingTooltip.remove();
                }
                if (isFavourite) {
                    // Add to favoriteItems if not already present
                    const exists = favouriteItems.some(item => item.name === itemToAddOrRemove.name);
                    if (!exists) {
                        favouriteItems.push(itemToAddOrRemove);
                    }
                } else {
                    // Remove from favoriteItems
                    favouriteItems = favouriteItems.filter(item => item.name !== itemToAddOrRemove.name);
                }

                // Update the heart icon based on `isFavourite`
                heartIconContainer.innerHTML = isFavourite ?
                    `<i class="rts" data-size="24" data-color="#000000" style="width: 24px; height: 24px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="width: 24px; height: 24px;"><path d="M14.05,6.72C8.17.2,2.57,7.54,3.67,11.76,5.56,19,14.05,23.57,14.05,23.57s7.74-4.16,10.39-11.81C25.86,7.64,20.24.13,14.05,6.72Z" style="fill:#000000;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px"></path></svg></i>` :
                    `<i class="rts" data-size="24" data-color="#000000" style="width: 24px; height: 24px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="width: 24px; height: 24px;"><path d="M14.05,6.72C8.17.2,2.57,7.54,3.67,11.76,5.56,19,14.05,23.57,14.05,23.57s7.74-4.16,10.39-11.81C25.86,7.64,20.24.13,14.05,6.72Z" style="fill:none;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px"></path></svg></i>`;
            } catch (error) {
                console.error('Error updating favorites:', error);
            }
        });
        // Add event listeners for the new icon
        newIconContainer.addEventListener('mouseenter', (event) => showTooltip(event, "{{ _("Add to cart")|escapejs }}"));
        // Append both icon containers to the iconContainer
        iconContainer.appendChild(newIconContainer);
        iconContainer.appendChild(heartIconContainer);
        // Finally, append the iconContainer to the imgWrapper or imgSection

        imgWrapper.appendChild(img);
        imgWrapper.appendChild(iconContainer);
        // Append the imgWrapper to the imgSection



        imgSection.appendChild(imgWrapper);

        if (item.pre_order){
            imgSection.appendChild(div_pre_order_icon);
            div_pre_order_icon.addEventListener('mouseenter', (event) => {
                showTooltip(event, "{{ _("This item is only available for pre-order")|escapejs }}");
            });
        }
        // Create the info section
        const infoSection = document.createElement('div');
        infoSection.className = 'info-section';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'info-name';

        var parts = item.product_name.split(" ");
        // Remove the last word
        let last_word = parts.pop();
        // Join the remaining parts to form the full phrase
        var full_phrase = parts.join(" ");
        nameSpan.textContent = translations_categories[full_phrase] ? translations_categories[full_phrase]+ " " + last_word : item.product_name;
        const priceSpan = document.createElement('span');
        priceSpan.className = 'info-price';
        priceSpan.textContent = currency + `${item.price}`;
        infoSection.appendChild(nameSpan);
        infoSection.appendChild(document.createElement('br'));
        infoSection.appendChild(priceSpan);

        // Assemble the product container
        productContainer.appendChild(imgSection);
        productContainer.appendChild(infoSection);

        // Append the product container to the products grid
        productsGrid.appendChild(productContainer);
        itemId+=1;
    });
}



function applyFilters() {
   const nameFilterValue = document.getElementById('contains-in-name').value.toLowerCase();
   const [from, to] = getParsed(fromSlider, toSlider);
   let itemsss = JSON.parse(JSON.stringify(allItems));
   filteredItems = itemsss.filter(item => {
        let isMatch = (category === "All" || (subcat[category] !== undefined ? subcat[category].concat(category).includes(item.category) : item.category === category)) &&
                      item.price <= to &&
                      item.price >= from &&
            (item.product_name.toLowerCase().includes(nameFilterValue) || item.name.toLowerCase().includes(nameFilterValue))&&
                      (baseFilters.length === 0 || baseFilters.includes(item.material));

        if (!isMatch) {
            return false;
        }
        let isCollectionMatch = collection_catalog === "All" || item.collection === collection_catalog;

        if(!isCollectionMatch){
             return false;
        }
        let orderedPlatings = {};
        let hasPlatingMatch = false;

        // Check for plating matches
        if (platingFilters.length > 0) {
            platingFilters.forEach(platingFilter => {
                if (item.platings.hasOwnProperty(platingFilter)) {
                    orderedPlatings[platingFilter] = item.platings[platingFilter];
                    hasPlatingMatch = true;
                }
            });
            Object.keys(item.platings).forEach(plating => {
                if (!orderedPlatings.hasOwnProperty(plating)) {
                    orderedPlatings[plating] = item.platings[plating];
                }
            });
        } else {
            orderedPlatings = item.platings;
            hasPlatingMatch = true;
        }

        // Process stones and sizes
        let finalPlatings = {};
        Object.keys(orderedPlatings).forEach(plating => {
            let stones = orderedPlatings[plating].stones;
            if(item.name==="57141") {
                console.log(item);
            }
            let orderedStones = {};
            let matchedStones = {};
            let allStones = {};
            let hasStoneMatch = false;

            if (stoneFilters.length > 0) {
                stoneFilters.forEach(stoneFilter => {
                    if (stones.hasOwnProperty(stoneFilter)) {
                        matchedStones[stoneFilter] = stones[stoneFilter];
                        hasStoneMatch = true;
                    }
                });

            } else {
                allStones = stones;
                hasStoneMatch = true;
            }
            orderedStones = { ...matchedStones, ...allStones};
            // Reorder and filter sizes within stones
            let finalStones = {};
            Object.keys(orderedStones).forEach(stoneKey => {
                let sizes = orderedStones[stoneKey].sizes;
                let orderedSizes = {};
                let hasSizeMatch = false;

                if (sizeFilters.length > 0) {
                    sizeFilters.forEach(sizeFilter => {
                        if (sizes.hasOwnProperty(sizeFilter)) {
                            orderedSizes[sizeFilter] = sizes[sizeFilter];
                            hasSizeMatch = true;
                        }
                    });
                    Object.keys(sizes).forEach(sizeKey => {
                        if (!orderedSizes.hasOwnProperty(sizeKey)) {
                            orderedSizes[sizeKey] = sizes[sizeKey];
                        }
                    });
                } else {
                    orderedSizes = sizes;
                    hasSizeMatch = true;
                }

                if (hasSizeMatch) {

                    finalStones[stoneKey] = { ...orderedStones[stoneKey], sizes: orderedSizes };
                }
            });

            if (hasStoneMatch && Object.keys(finalStones).length > 0) {
                finalPlatings[plating] = { stones: finalStones };
            }
        });

        if (hasPlatingMatch && Object.keys(finalPlatings).length > 0) {
            item.platings = finalPlatings;
        } else {
            return false;
        }

        return true;
   });
   if(sizeFilters.length === 0){
       for (let productName in filteredItems) {
        for (let platingName in filteredItems[productName].platings) {
            for (let stoneName in filteredItems[productName].platings[platingName].stones) {
                let stoneEntry = filteredItems[productName].platings[platingName].stones[stoneName];
                if (stoneEntry.sizes) {
                    stoneEntry.sizes = orderSizes(stoneEntry.sizes);
                }
            }
        }
    }
   }
   if (filteredItems.length === 0) {
       filteredItems.push("{{ _("No items found")|escapejs }}");
   }
   else{
       filteredItems.forEach(item => {
            let first_plating = Object.values(item.platings)[0];
            let first_stone = Object.values(first_plating.stones)[0];
            item.preview_image = first_stone['image'];
       });

   }

   currentPage = 1;
   total_pages = Math.ceil(filteredItems.length / itemsPerPage);
   constructCrystals(filteredItems, stoneFilters, "{% static "images/crystals" %}");
   changePage(1);
}


function order(array){
    if(order_name==="Name") {
        array.sort((a, b) => {
            if(order_type==="asc") {
                if (a.name < b.name) {
                    return -1;
                }
                if (a.name > b.name) {
                    return 1;
                }
                return 0;
            }
            else if(order_type==="desc") {
                if (a.name > b.name) {
                    return -1;
                }
                if (a.name < b.name) {
                    return 1;
                }
                return 0;
            }
        });
    }
    else if (order_name==="Price"){
        array.sort((a, b) => {
            if(order_type==="asc") {
                if (a.price < b.price) {
                    return -1;
                }
                if (a.price > b.price) {
                    return 1;
                }
                return 0;
            }
            else if(order_type==="desc") {
                if (a.price > b.price) {
                    return -1;
                }
                if (a.price < b.price) {
                    return 1;
                }
                return 0;
            }
        });
    }
}
function updatePage() {
    let paginatedItems;
    let found = true;
    if(filteredItems.length === 0){
        order(allItems);
        paginatedItems = paginateItems(allItems, currentPage, itemsPerPage);
    }
    else{
        if(filteredItems[0] === "No items found"){
            paginatedItems = paginateItems([], currentPage, itemsPerPage);

            found = false;
        }
        else {
            order(filteredItems);
            paginatedItems = paginateItems(filteredItems, currentPage, itemsPerPage);
        }
    }
    const current = document.getElementById('current-page');
    current.innerText="{{ _("Current page")|escapejs }}:" + currentPage;
    displayCurrentPage(paginatedItems);
    if(found===false){
        const grid = document.querySelector('.products-grid');
        const span = document.createElement('h2');
        span.textContent = "{{ _("No items found")|escapejs }}:";
        span.style.gridColumn = "1/-1";
        span.style.textAlign = 'center';
        span.style.color = "#4d4d4d"
        grid.appendChild(span);
    }
}


document.getElementById('previous-button').addEventListener('click', function (event){
    event.preventDefault();
    if(currentPage>1){
        currentPage-=1;
        changePage(currentPage);
    }
});

document.getElementById('next-button').addEventListener('click', function (event){
    event.preventDefault();
    if(currentPage<total_pages){
        currentPage+=1;
        changePage(currentPage);
    }
});

document.getElementById('button-jump-to').addEventListener('click', function (event) {
    event.preventDefault();
    let page_number = Number(document.getElementById('page-number-input').value);
    if(page_number>0 && page_number<=total_pages){
        currentPage = page_number;
        changePage(currentPage);
    }
});

document.getElementById('select-items-per-page').addEventListener('change', function (event) {
    itemsPerPage = Number(event.target.value);
    if(filteredItems.length === 0) {
        total_pages = Math.ceil(allItems.length / itemsPerPage);
    }
    else{
         total_pages = Math.ceil(filteredItems.length / itemsPerPage);
    }
    currentPage = 1;
    changePage(1);
});
document.getElementById('select-order').addEventListener('change', function (event) {
    let order = (event.target.value).split(', ');

    order_name = order[0];
    order_type=order[1];
    changePage(1);
});

 $(document).ready(function(){
    $('.slider').on('input change', function() {
        const container_shows = document.getElementById('value-of-slider-price');
        container_shows.innerText = $(this).val();
    });
});

document.querySelectorAll('.quantity-input-dialog').forEach(input => {
    input.addEventListener('input', function() {
        console.log(this.value);
    })
});
document.querySelectorAll('.quantity-input-dialog').forEach(input => {
    input.addEventListener('change', function() {
        console.log(this.value);
    })
});

document.getElementById('product-card').addEventListener('click', async (event) => {
    const heartIconContainer = event.target.closest('.mobile-heart-container');
    if (!heartIconContainer) return;

    const item = JSON.parse(heartIconContainer.getAttribute('data-item-name')); // Assumes each heartIconContainer has `data-item-name`

    const favouriteItem = favouriteItems.find(item_fav => item_fav.name === item.name); // Assuming `item.name` is the name of your current item
    const isFavBefore = Boolean(favouriteItem); // Converts the result to a boolean


    // Stop the event from propagating to other elements
    event.stopPropagation();
    try {
        // Replace `yourItemId` with the actual item ID or any identifier you use
        const response = await fetch('{% url "change_favorite_state" %}', {
            method: 'POST', // or 'DELETE' if removing from favorites
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),

                // Include other headers as needed, like authorization tokens
            },
            body: JSON.stringify({item: JSON.stringify(item), "alreadyFavourite": isFavBefore ? "true":"false"}),
        });

        if (!response.ok) throw new Error('Network response was not ok.');

        // Assuming the backend responds with the updated favorite status
        const data = await response.json();
        const isFavourite = data.isFavourite === "true";
        const itemToAddOrRemove = JSON.parse(data.item); // Assuming this is an object {name_id: "someId", ...}
        const existingTooltip = document.querySelector('.custom-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
        if (isFavourite) {
            // Add to favoriteItems if not already present
            const exists = favouriteItems.some(item => item.name === itemToAddOrRemove.name);
            if (!exists) {
                favouriteItems.push(itemToAddOrRemove);
            }
        } else {
            // Remove from favoriteItems
            favouriteItems = favouriteItems.filter(item => item.name !== itemToAddOrRemove.name);
        }

        // Update the heart icon based on `isFavourite`
        heartIconContainer.innerHTML = isFavourite ?
            `<div class="favourites-mobile-container"><span class="mobile-favourites-btn">` + "{{ _("Remove from favorites")|escapejs }}" + `<i class="rts" data-size="24" data-color="#000000" style="width: 24px; height: 24px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="width: 24px; height: 24px;"><path d="M14.05,6.72C8.17.2,2.57,7.54,3.67,11.76,5.56,19,14.05,23.57,14.05,23.57s7.74-4.16,10.39-11.81C25.86,7.64,20.24.13,14.05,6.72Z" style="fill:#000000;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px"></path></svg></i> </span></div>` :
            `<div class="favourites-mobile-container"><span class="mobile-favourites-btn">` + "{{ _("Add to favorites")|escapejs }}" + `<i class="rts" data-size="24" data-color="#000000" style="width: 24px; height: 24px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" style="width: 24px; height: 24px;"><path d="M14.05,6.72C8.17.2,2.57,7.54,3.67,11.76,5.56,19,14.05,23.57,14.05,23.57s7.74-4.16,10.39-11.81C25.86,7.64,20.24.13,14.05,6.72Z" style="fill:none;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px"></path></svg></i> </span></div>`; // Example with FontAwesome
    } catch (error) {
        console.error('Error updating favorites:', error);
    }
});
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
</html>
{%endblock%}