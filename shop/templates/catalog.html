{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet"  href="{% static 'css/catalog.css' %}">
    <!-- Add this script tag to your HTML to include Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
{% include 'base.html' %}
<div class="everything">
    <div class="filters-section">
        <div class="filter-price">
            <input type="range" class="slider" id="slider-price" min="0" max="1000" step="10">
        </div>
        <span id="value-of-slider-price"></span>
        <input type="text" id="contains-in-name" placeholder="Contains in name...">
        <button id="submit-button">Submit</button>
    </div>
    <div class="products-section">
        <div>
            <span>Items per page: </span>
            <select id="select-items-per-page">
                <option>20</option>
                <option>50</option>
                <option>100</option>
            </select>
        </div>
        <div class="products-grid">

        </div>

        <dialog id="product-card" style="display: none">

        </dialog>
        <div class="pages" id="pages">
            <a id="jump-to-first" href="">Jump to first</a> |
            <a id="previous-button" href="">Previous</a> |

            <span id="current-page">Current page: </span> |

            <a id="next-button" href="">Next</a> |
            <a id="jump-to-last" href="">Jump to last</a>

            <div id="jump" >
                <input id="page-number-input" type="number">
                <button id="button-jump-to">Jump</button>
            </div>
        </div>
</div>
</div>
</body>
<script  type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';

    import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    var firebaseConfig = {
    apiKey: "AIzaSyAM0wDc_WO0wP3-_TPRPLENZDIHbezH7U4",
    authDomain: "flutterapp-fd5c3.firebaseapp.com",
    projectId: "flutterapp-fd5c3",
    storageBucket: "flutterapp-fd5c3.appspot.com",
    messagingSenderId: "486422895050",
    appId: "1:486422895050:web:b67eaef185d40579879733",
    measurementId: "G-JT2QVDEHLT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

     async function countDocuments() {
        const itemsRef = collection(db, "item");
        const q = query(itemsRef, where("quantity", ">", 0));
        const querySnapshot = await getDocs(q);
         {#console.log(`Number of documents in 'items' collection: ${querySnapshot.size/20}`);#}
        return querySnapshot.size;
    }
let itemsPerPage = 20;
let number_of_documents;
let currentPage = 1;
let total_pages = 1;
let allItems = [];
let filteredItems = [];
async function fetchAllItems() {
        const itemsQuery = query(collection(db, "item") , where("quantity", ">", 0));//
        const querySnapshot = await getDocs(itemsQuery);
        return querySnapshot.docs.map(doc => doc.data());
    }
function paginateItems(items, pageNumber, pageSize) {
        const startIndex = (pageNumber - 1) * pageSize;
        return items.slice(startIndex, startIndex + pageSize);
}
function filterItems(items, pageNumber, pageSize) {
        const startIndex = (pageNumber - 1) * pageSize;
        return items.slice(startIndex, startIndex + pageSize);
}
function displayCurrentPage(items) {
    const productsGrid = document.querySelector('.products-grid');
    productsGrid.innerHTML = '';
    let itemId= 0;
    items.forEach((item) => {
        const productContainer = document.createElement('div');
        productContainer.className = 'product-container';
        productContainer.id = `product-${item.name}`;
        productContainer.setAttribute('data-id', itemId);

        productContainer.addEventListener('click', () => {
            generateDialogContent(`${item.name}`);
        });

        // Create the image section
        const imgSection = document.createElement('div');
        imgSection.className = 'img-section';
        const img = document.createElement('img');
        img.src = item.image_url;
        img.width = 150;
        img.height = 150;
        img.style.borderRadius = '10px';
        imgSection.appendChild(img);

        // Create the info section
        const infoSection = document.createElement('div');
        infoSection.className = 'info-section';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'info-name';
        nameSpan.textContent = item.name;
        const priceSpan = document.createElement('span');
        priceSpan.className = 'info-price';
        priceSpan.textContent = `€${item.price}`;
        infoSection.appendChild(nameSpan);
        infoSection.appendChild(document.createElement('br'));
        infoSection.appendChild(priceSpan);


        // Assemble the product container
        productContainer.appendChild(imgSection);
        productContainer.appendChild(infoSection);

        // Append the product container to the products grid
        productsGrid.appendChild(productContainer);
        itemId+=1;
    });
}
function applyFilters() {
  const sliderValue = document.getElementById('slider-price').value;
  const nameFilterValue = document.getElementById('contains-in-name').value.toLowerCase();

   filteredItems = allItems.filter(item =>
    item.price <= sliderValue &&
    item.name.toLowerCase().includes(nameFilterValue)
  );
   currentPage = 1;
   total_pages = Math.ceil(filteredItems.length / itemsPerPage);
  updatePage();
}
function updatePage() {
    let paginatedItems;
    if(filteredItems.length === 0){
        paginatedItems = paginateItems(allItems, currentPage, itemsPerPage);
    }
    else{
        paginatedItems = paginateItems(filteredItems, currentPage, itemsPerPage);
    }
    const current = document.getElementById('current-page');
    current.innerText="Current page: " + currentPage;
    displayCurrentPage(paginatedItems);
}

function productsTransmutation(items){

    let products = {};
    const regex = /^[a-zA-Z]{0,2}\d{5}[a-zA-Z]{0,5}$/;
    items.forEach(item => {

        let itemName = item.name;

        itemName = itemName.split(' ')[0];//.replace(/[a-zA-Z]/g, '').replace(/RG/g, '').replace(/G/g, '').replace(/R/g, '').replace(/XL/g, '').replace(/L/g, '').replace(/M/g, '').replace(/S/g, '').replace(/XS/g, '');

         if (regex.test(itemName)) {
            let processedName = itemName.match(/^([a-zA-Z]{0,2})(\d{5})/);
             // This includes both the initial letters and the 5 digits
             itemName = processedName[0];
            {#console.log("Yes " + finalName + "     " + item.name);#}
        } else {
            itemName = (item.name).split(' ')[0];
            {#console.log("No " + item.name);#}
        }

        if (!products[itemName] ) { //&& item.plating && item.stone
                products[itemName] = {
                    name: itemName,
                    description: item.description,
                    price: item.price,
                    category: item.category,
                    material: item.material,
                    platings: {}
                };
            }
            if (item.plating) {
                // Initialize plating if it doesn't exist.
                if (!products[itemName].platings[item.plating]) {
                    products[itemName].platings[item.plating] = {
                        stones: {},
                    };
                }

                // Proceed only if stone is defined.
                if (item.stone) {
                    // Initialize the stone if it doesn't exist under the current plating.
                    if (!products[itemName].platings[item.plating].stones[item.stone]) {
                        products[itemName].platings[item.plating].stones[item.stone] = {
                            sizes: {},
                            image: item.image_url
                        };
                    }

                    // If size is present, add or update the size and quantity for the stone.
                    if (item.size) {
                        let stoneSizes = products[itemName].platings[item.plating].stones[item.stone].sizes;
                        if (!stoneSizes[item.size]) {
                            stoneSizes[item.size] = item.quantity;
                        } else {
                            // Assuming you want to sum quantities for the same size.
                            stoneSizes[item.size] += item.quantity;
                        }
                    } else {
                        // If there's no size, add the quantity directly to the stone.
                        if (!products[itemName].platings[item.plating].stones[item.stone].quantity) {
                            products[itemName].platings[item.plating].stones[item.stone].quantity = item.quantity;
                        } else {
                            products[itemName].platings[item.plating].stones[item.stone].quantity += item.quantity;
                        }
                    }
                }
            }



    });
    return Object.values(products);
}

document.addEventListener("DOMContentLoaded", async function () {
    itemsPerPage = Number(document.getElementById('select-items-per-page').value);
    console.log(itemsPerPage);
    {#number_of_documents = Number( await countDocuments());#}
    {#console.log(number_of_documents);#}
    let unfilteredItems = await fetchAllItems(); // Fetch all items on load

    allItems = productsTransmutation(unfilteredItems);
    console.log(allItems.length);
    total_pages = Math.ceil(allItems.length / itemsPerPage);
    console.log(total_pages);

    updatePage();
    document.getElementById('submit-button').addEventListener('click', applyFilters);

});

document.getElementById('previous-button').addEventListener('click', function (event){
    event.preventDefault();
    if(currentPage>1){
        currentPage-=1;
        updatePage();
    }
});

document.getElementById('next-button').addEventListener('click', function (event){
    event.preventDefault();
    if(currentPage<total_pages){
        currentPage+=1;
        updatePage();
    }
});
document.getElementById('jump-to-last').addEventListener('click', function (event){
    event.preventDefault();
    currentPage=total_pages;
    updatePage();
});
document.getElementById('jump-to-first').addEventListener('click', function (event){
    event.preventDefault();
    currentPage=1;
    updatePage();

});
document.getElementById('button-jump-to').addEventListener('click', function (event) {
    event.preventDefault();
    let page_number = Number(document.getElementById('page-number-input').value);
    if(page_number>0 && page_number<=total_pages){
        currentPage = page_number;
        updatePage();
    }
});

document.getElementById('select-items-per-page').addEventListener('change', function (event) {
    itemsPerPage = Number(event.target.value);
    total_pages = Math.ceil(number_of_documents / itemsPerPage);
    updatePage();
});

 $(document).ready(function(){
    $('.slider').on('input change', function() {
        const container_shows = document.getElementById('value-of-slider-price');
        container_shows.innerText = $(this).val();
    });
});

document.querySelectorAll('.quantity-input-dialog').forEach(input => {
    input.addEventListener('input', function() {
        console.log(this.value);
    })
});
document.querySelectorAll('.quantity-input-dialog').forEach(input => {
    input.addEventListener('change', function() {
        console.log(this.value);
    })
});

function fulfilDropdown(dropdown, array){
    if(array) {
        (Object.keys(array)).forEach(element => {
            let option = document.createElement('option');
            option.innerText = element;
            option.value = element;
            dropdown.add(option);
        });
    }

}
function updatePlatings(selectedPlating, stoneSelect, sizeSelect, image){
    const firstStone = selectedPlating ? Object.values(selectedPlating.stones || {})[0] : null;

    while (stoneSelect.firstChild) {
        stoneSelect.removeChild(stoneSelect.firstChild);
    }
    fulfilDropdown(stoneSelect, selectedPlating.stones);
    updateStones(firstStone, sizeSelect, image );
}
function updateStones(selectedStone, sizeSelect, image){

    const firstSizeKey = selectedStone ? Object.keys(selectedStone.sizes || {})[0] : null;
    const withSizes = !!firstSizeKey;
    const firstSizeQuantity = withSizes ? selectedStone.sizes[firstSizeKey] : selectedStone.quantity;
    if (selectedStone?.image) {
        image.src = selectedStone.image; // Update the image src
    }

    while (sizeSelect.firstChild) {
        sizeSelect.removeChild(sizeSelect.firstChild);
    }
    if(withSizes) {
        fulfilDropdown(sizeSelect, selectedStone.sizes);
        updateSizes(firstSizeQuantity);
    }

}
function updateSizes(sizeQuantity){




}

function generateDialogContent(id){

    document.body.style.overflow = 'hidden';
    const item = allItems.find(item => item.name === id);
    console.log(item);
    if (!item) {
        console.error('Item not found');
        return;
    }

    const firstPlatingKey = Object.keys(item.platings)[0];
    const firstPlating = item.platings[firstPlatingKey];

    // Get the first stone in the first plating
    const firstStoneKey = firstPlating && Object.keys(firstPlating.stones)[0];
    const firstStone = firstPlating ? firstPlating.stones[firstStoneKey] : null;

    // Get the first size in the first stone
    const firstSizeKey = firstStone && Object.keys(firstStone.sizes)[0];
    const firstSize = firstStone ? firstStone.sizes[firstSizeKey] : null;

    // If you need specific properties from the first size, for example, 'quantity':
    const firstSizeQuantity = firstSize ? firstSize.quantity : null;

    const dialog = document.getElementById('product-card');
    document.addEventListener('click', (event) => {
        const rect = dialog.getBoundingClientRect();
        const isInDialog = (rect.top <= event.clientY && event.clientY <= rect.top + rect.height
                            && rect.left <= event.clientX && event.clientX <= rect.left + rect.width);

        // Check if the event target is inside a select element or another form control
        let targetElement = event.target;
        while (targetElement != null) {
            if (targetElement.tagName === 'SELECT' || targetElement.tagName === 'OPTION') {
                // If the click is inside the dialog or on a select element, do nothing
                return;
            }
            targetElement = targetElement.parentNode; // Move up the DOM tree
        }

        if (!isInDialog && dialog.open) {
            document.body.style.overflow = '';
            dialog.style.display = 'none';
            dialog.close();
        }
    }, true);
    dialog.innerHTML = '';

    const card_content = document.createElement('div');
    card_content.classList.add('card-content');




    let imagePath = '';
    let quantity_max = 1;

    if (firstStone) {
        imagePath = firstStone.image || '';
        quantity_max = Object.keys(firstStone.sizes || {}).length === 0 ? firstStone.quantity : -4;
    }

    const image = document.createElement('img');
    image.src = imagePath;
    image.width = `400`;
    image.height = `400`;
    image.classList.add('img-card');
    card_content.appendChild(image);





    const close_dialog = document.createElement('div');
    const icon_close = document.createElement('i');
    icon_close.classList.add('fa-solid', 'fa-close');
    close_dialog.appendChild(icon_close);
    close_dialog.addEventListener('click',()=>{
       document.body.style.overflow = '';
       dialog.style.display = 'none';
       dialog.close();
    });

    close_dialog.classList.add('close-card');
    card_content.appendChild(close_dialog);


    const secondColumn = document.createElement('div');
    secondColumn.classList.add('second-column');

    const nameSpan = document.createElement('h1');
    nameSpan.textContent = `${item.name}`;
    secondColumn.appendChild(nameSpan);

    const priceSpan = document.createElement('div');
    priceSpan.textContent = `€${item.price}`;
    secondColumn.appendChild(priceSpan);


    const quantitySpan = document.createElement('div');
    quantitySpan.textContent = `Max: ${quantity_max}`;
    secondColumn.appendChild(quantitySpan);


    const platingsSelect = document.createElement('select');
    fulfilDropdown(platingsSelect, item.platings);
    secondColumn.appendChild(platingsSelect);

    const stoneSelect = document.createElement('select');
    fulfilDropdown(stoneSelect, firstPlating.stones);
    secondColumn.appendChild(stoneSelect);

    const sizeSelect = document.createElement('select');
    if(Object.keys(firstStone.sizes).length>0) {
        fulfilDropdown(sizeSelect, firstStone.sizes);
        secondColumn.appendChild(sizeSelect);
    }

    platingsSelect.addEventListener('change', (event) => {
        const selectedPlatingKey = event.target.value;
        const selectedPlating = item.platings[selectedPlatingKey];
        updatePlatings(selectedPlating, stoneSelect, sizeSelect, image);
    });
    stoneSelect.addEventListener('change', (event) => {
        const selectedStoneKey = event.target.value;
        const selectedPlatingKey = platingsSelect.value;
        const selectedPlating = item.platings[selectedPlatingKey];
        const selectedStone = selectedPlating && selectedPlating.stones ? selectedPlating.stones[selectedStoneKey] : null;

        updateStones(selectedStone, sizeSelect, image);

    });





    const bottom_part = document.createElement('div');
    bottom_part.classList.add('bottom-card-part');

    const counter = document.createElement('div');

    const button_minus = document.createElement('button');
    button_minus.innerText = '-';
    button_minus.classList.add('minus-button-dialog');
    const inputQuantity = document.createElement('input');
    inputQuantity.type = 'number';
    inputQuantity.style.textAlign = 'center';
    inputQuantity.value = 1;
    inputQuantity.classList.add('quantity-input-dialog');
    inputQuantity.min = '1';
    inputQuantity.max = item.quantity;

    inputQuantity.addEventListener('input', function() {
        console.log(quantity_max);
        if(inputQuantity.value > quantity_max || inputQuantity.value < 1 ){
            inputQuantity.value = 1;
            alert('Quantity number has to be less than or equal to quantity number in stock or and be greater than 0');
        }
    });

    button_minus.addEventListener('click', () => {
        if(inputQuantity.value > 1)
            inputQuantity.value -= 1;
    });
    const button_plus = document.createElement('button');
    button_plus.innerText = '+';
    button_plus.classList.add('plus-button-dialog');
    button_plus.addEventListener('click', () => {
        if(inputQuantity<item.quantity) {
            let currentValue = Number(inputQuantity.value === "" ? 1 : inputQuantity.value);
            inputQuantity.value = currentValue + 1;
            console.log(item.name);
        }
    });
    counter.appendChild(button_minus);
    counter.appendChild(inputQuantity);
    counter.appendChild(button_plus);



    const add_to_cart = document.createElement('button');
    add_to_cart.type = 'submit';
    add_to_cart.classList.add('add-to-cart-dialog');
    const icon_cart = document.createElement('i');
    icon_cart.classList.add('fa-solid', 'fa-cart-shopping');
    add_to_cart.appendChild(icon_cart);
    const text_add_to_cart = document.createElement('span');
    text_add_to_cart.innerText = ' Add to cart';
    add_to_cart.appendChild(icon_cart);
    add_to_cart.appendChild(text_add_to_cart);
    bottom_part.appendChild(counter);
    bottom_part.appendChild(add_to_cart);
    secondColumn.appendChild(bottom_part);

    card_content.appendChild(secondColumn);
    dialog.appendChild(card_content);

    dialog.style.display = 'block';
    dialog.showModal();

 }

</script>
</html>
{%endblock%}